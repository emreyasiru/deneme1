@{
    ViewData["Title"] = "UrunEkle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model eticaret.Modeller.UrunKayit

<div class="col">
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @ViewBag.ErrorMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
    }

    @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
    {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
            @ViewBag.SuccessMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
    }

    <div class="card-body">
        <form action="@Url.Action("UrunEkle", "Admin")" method="post" enctype="multipart/form-data" class="form-horizontal">

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="UrunAdi" class="form-control-label">Ürün Adı <span class="text-danger" >*</span></label>
                </div>
                <div class="col-12 col-md-9">
                    <input type="text" id="UrunAdi" name="UrunAdi" placeholder="Ürün adını giriniz" class="form-control" required>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="StokAdeti" class="form-control-label">Stok Adeti</label>
                </div>
                <div class="col-12 col-md-9">
                    <input type="number" id="StokAdeti" name="StokAdeti" placeholder="Adet giriniz" class="form-control" min="0" step="1">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="Aciklama" class="form-control-label">Ürün Açıklaması</label>
                </div>
                <div class="col-12 col-md-9">
                    <textarea name="Aciklama" id="Aciklama" rows="9" placeholder="Açıklama..." class="form-control"></textarea>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="AlisFiyati" class="form-control-label">Alış Fiyatı</label>
                </div>
                <div class="col-12 col-md-9">
                    <input type="number" id="AlisFiyati" name="AlisFiyati" placeholder="0.00" class="form-control" min="0" step="0.01">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="SatisFiyati" class="form-control-label">Satış Fiyatı</label>
                </div>
                <div class="col-12 col-md-9">
                    <input type="number" id="SatisFiyati" name="SatisFiyati" placeholder="0.00" class="form-control" min="0" step="0.01">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="IndirimliFiyat" class="form-control-label">İndirimli Fiyat</label>
                </div>
                <div class="col-12 col-md-9">
                    <input type="number" id="IndirimliFiyat" name="IndirimliFiyat" placeholder="0.00" class="form-control" min="0" step="0.01">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="kategori" class="form-control-label">Kategori <span class="text-danger">*</span></label>
                </div>
                <div class="col-12 col-md-9" id="ekleme">
                    <select name="Kategori" id="kategori" class="form-select" onchange="secim()" required>
                        <option value="">Kategori Seç</option>
                        @foreach (var itemm in Model.Kategorilerim)
                        {
                                    <option value="@itemm.Id">@itemm.KategoriAdi</option>
                        }
                    </select>

                    <input type="hidden" name="GercekKategori" id="gercekKategori" value="">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="Vergi" class="form-control-label">Vergi Dilimi</label>
                </div>
                <div class="col-12 col-md-9">
                    <select name="Vergi" id="Vergi" class="form-select">
                        <option value="0">Vergi Seçiniz</option>
                        @foreach (var item in Model.Vergilerim)
                        {
                                    <option value="@item.Id">@item.Adi - @item.Orani %</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col col-md-3">
                    <label for="Gorseller" class="form-control-label">Ürün Görselleri</label>
                </div>
                <div class="col-12 col-md-9">
                    <input type="file" id="Gorseller" name="Gorseller" multiple accept="image/*" class="form-control" onchange="gorselleriGoster()">
                    <small class="form-text text-muted">
                        Desteklenen formatlar: JPG, JPEG, PNG, GIF, BMP, WEBP. Birden fazla görsel seçebilirsiniz.
                    </small>

                    <!-- Seçilen görsellerin önizlemesi -->
                    <div id="gorselOnizleme" class="mt-3" style="display: none;">
                        <label class="form-label fw-bold">Seçilen Görseller (Ana görseli seçmek için tıklayın):</label>
                        <div id="gorselListesi" class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Ana görsel index'i gizli input olarak gönder -->
                    <input type="hidden" id="AnaGorselIndex" name="AnaGorselIndex" value="0">
                </div>
            </div>

            <div class="card-footer d-flex justify-content-end">
                <button type="submit" class="btn btn-primary btn-md mx-3">
                    <i class="fa fa-dot-circle-o"></i> Kaydet
                </button>
                <button type="reset" class="btn btn-danger btn-md" onclick="temizleForm()">
                    <i class="fa fa-ban"></i> Sıfırla
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .gorsel-onizleme-item {
        position: relative;
        width: 120px;
        height: 120px;
        border: 3px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .gorsel-onizleme-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .gorsel-onizleme-item.ana-gorsel {
        border-color: #28a745;
        border-width: 4px;
    }

    .gorsel-onizleme-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .gorsel-onizleme-item .ana-gorsel-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
    }

    .gorsel-onizleme-item .gorsel-sira {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
</style>

<script>
    // Global değişkenler
    let enSonSecilenKategori = "";
    let secilenAnaGorselIndex = 0;

    // Kategori fonksiyonları
    function secim() {
        var ekle = document.getElementById("kategori").value;
        var alan = document.getElementById("ekleme");

        // Ana kategori seçildiğinde global değişkeni ve hidden input'u güncelle
        enSonSecilenKategori = ekle;
        document.getElementById("gercekKategori").value = ekle;

        // Önceki dinamik içerikleri temizle
        temizleDinamikIcerik();

        if (!ekle || ekle === "") {
            enSonSecilenKategori = "";
            document.getElementById("gercekKategori").value = "";
            return;
        }

        $.ajax({
            url: "@Url.Action("KategoriGetir", "Admin")",
            type: "GET",
            data: { id: ekle },
            success: function (cevap) {
                alan.insertAdjacentHTML('beforeend', cevap);
            },
            error: function (xhr) {
                console.error("Ajax hatası:", xhr.responseText);
            }
        });
    }

    function secimim(selectElement) {
        var ekle = selectElement.value;
        var alan = document.getElementById("ekleme");
        var mevcutSeviye = parseInt(selectElement.getAttribute('data-seviye'));

        // Alt kategori seçildiğinde global değişkeni ve hidden input'u güncelle
        if (ekle && ekle !== "") {
            enSonSecilenKategori = ekle;
            document.getElementById("gercekKategori").value = ekle;
        }

        // Bu seviyeden sonraki tüm içerikleri temizle
        temizleSonrakiSeviyeler(mevcutSeviye);

        if (!ekle || ekle === "") {
            return;
        }

        $.ajax({
            url: "@Url.Action("AltKategoriGetir", "Admin")",
            type: "GET",
            data: { id: ekle },
            success: function (cevap) {
                alan.insertAdjacentHTML('beforeend', cevap);
            },
            error: function (xhr) {
                console.error("Ajax hatası:", xhr.responseText);
            }
        });
    }

    function temizleDinamikIcerik() {
        var alan = document.getElementById("ekleme");
        var dinamikElementler = alan.querySelectorAll('.alert, select[data-seviye]');
        dinamikElementler.forEach(function(element) {
            element.remove();
        });
    }

    function temizleSonrakiSeviyeler(mevcutSeviye) {
        var alan = document.getElementById("ekleme");
        var sonrakiElementler = alan.querySelectorAll('select[data-seviye]');

        sonrakiElementler.forEach(function(element) {
            var elementSeviye = parseInt(element.getAttribute('data-seviye'));
            if (elementSeviye > mevcutSeviye) {
                var sonrakiAlert = element.nextElementSibling;
                if (sonrakiAlert && sonrakiAlert.classList.contains('secilen-kategori')) {
                    sonrakiAlert.remove();
                }
                element.remove();
            }
        });

        var alerts = alan.querySelectorAll('.secilen-kategori');
        alerts.forEach(function(alert, index) {
            if (index >= mevcutSeviye - 1) {
                alert.remove();
            }
        });
    }

    // Görsel önizleme fonksiyonları
    function gorselleriGoster() {
        const fileInput = document.getElementById('Gorseller');
        const onizlemeAlani = document.getElementById('gorselOnizleme');
        const gorselListesi = document.getElementById('gorselListesi');
        const files = fileInput.files;

        // Temizle
        gorselListesi.innerHTML = '';

        if (files.length === 0) {
            onizlemeAlani.style.display = 'none';
            return;
        }

        onizlemeAlani.style.display = 'block';
        secilenAnaGorselIndex = 0; // İlk görseli varsayılan olarak seç
        document.getElementById('AnaGorselIndex').value = 0;

        // Her görsel için önizleme oluştur
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'gorsel-onizleme-item' + (i === 0 ? ' ana-gorsel' : '');
                div.setAttribute('data-index', i);
                div.onclick = function() { anaGorselSec(i); };

                div.innerHTML = `
                    <img src="${e.target.result}" alt="Görsel ${i + 1}">
                    <span class="gorsel-sira">${i + 1}</span>
                    ${i === 0 ? '<span class="ana-gorsel-badge">ANA GÖRSEL</span>' : ''}
                `;

                gorselListesi.appendChild(div);
            };

            reader.readAsDataURL(file);
        }
    }

    function anaGorselSec(index) {
        secilenAnaGorselIndex = index;
        document.getElementById('AnaGorselIndex').value = index;

        // Tüm görsellerden ana-gorsel class'ını kaldır
        document.querySelectorAll('.gorsel-onizleme-item').forEach(item => {
            item.classList.remove('ana-gorsel');
            const badge = item.querySelector('.ana-gorsel-badge');
            if (badge) badge.remove();
        });

        // Seçilen görsele ana-gorsel class'ı ekle
        const secilenItem = document.querySelector(`[data-index="${index}"]`);
        if (secilenItem) {
            secilenItem.classList.add('ana-gorsel');
            const badge = document.createElement('span');
            badge.className = 'ana-gorsel-badge';
            badge.textContent = 'ANA GÖRSEL';
            secilenItem.appendChild(badge);
        }
    }

    // Form submit edilirken kontrol
    document.querySelector('form').addEventListener('submit', function(e) {
        var gercekKategoriInput = document.getElementById("gercekKategori");

        // Hiçbir kategori seçilmemişse hata ver
        if (!gercekKategoriInput.value || gercekKategoriInput.value === "") {
            alert('Lütfen bir kategori seçiniz!');
            e.preventDefault();
            return false;
        }

        return true;
    });

    // Sıfırla butonu fonksiyonu
    function temizleForm() {
        // Dinamik kategori içeriklerini temizle
        temizleDinamikIcerik();
        document.getElementById('gercekKategori').value = '';
        enSonSecilenKategori = '';

        // Görsel önizlemesini temizle
        document.getElementById('gorselOnizleme').style.display = 'none';
        document.getElementById('gorselListesi').innerHTML = '';
        document.getElementById('AnaGorselIndex').value = '0';
        secilenAnaGorselIndex = 0;
    }
</script>